<div class="min-h-dvh flex flex-col bg-white">

  <!-- Mobile header with progress -->
  <div class="md:hidden sticky top-0 z-20 bg-white border-b border-gray-300 px-4 py-3">
    <div class="flex items-center justify-center gap-2">
          <img src="/icons/schedulr-logo-new.svg" width="32" height="32" alt="" class="rounded-md" />
          <span class="font-bold text-xl text-text-main tracking-tight">Schedulr.</span>
        </div>
    <!-- <div class="flex items-center justify-between">
      <button type="button" (click)="prevStep()" [disabled]="currentStepIndex === 0"
        class="px-3 py-1.5 border border-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
        ← Back
      </button>
      <div class="flex items-center gap-2">
        @for (s of steps; let i = $index; track i) {
          <span [ngClass]="{
                  'bg-brand-600 text-white': i === currentStepIndex,
                  'bg-gray-200 text-gray-700': i !== currentStepIndex
                }"
                class="w-6 h-6 rounded-full text-xs flex items-center justify-center">
            {{ i + 1 }}
          </span>
        }
      </div>
      <button type="button" (click)="nextStep()" [disabled]="currentStepIndex === steps.length - 1"
        class="px-3 py-1.5 border border-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
        Next →
      </button>
    </div>
    <div class="mt-2 h-1.5 rounded-full bg-gray-100 overflow-hidden">
      <div class="h-full bg-brand-600 transition-all" [style.width.%]="progressPercent"></div>
    </div> -->
  </div>

  <!-- Desktop layout -->
  <div  class="flex-1 bg-cover bg-center md:bg-none! flex justify-center md:grid md:grid-cols-5 xl:grid-cols-9 gap-8 p-8 md:p-4">
    <!-- Stepper (left) -->
  <aside style="background-image: url('/images/doodle-3.png');" class="hidden bg-cover bg-center col-span-2 xl:col-span-3 px-12 rounded-lg md:flex items-center">
      <div class="sticky w-full top-6">
        <div class="flex items-center gap-2 mb-6">
          <img src="/icons/schedulr-logo-new.svg" width="32" height="32" alt="" class="rounded-md" />
          <span class="font-bold text-xl text-text-main tracking-tight">Schedulr.</span>
        </div>

        <ol class="space-y-3">
          @for (s of steps; let i = $index; track i) {
            <li>
              <button [disabled]="!isStepAccessible(s.key)" type="button" (click)="goToStep(s.key)"
                class="disabled:cursor-not-allowed disabled:opacity-35 w-full shadow-xs text-left p-3 border rounded-lg transition-colors"
                [ngClass]="{
                  'border-brand-600 bg-brand-50 text-brand-600': i === currentStepIndex,
                  'border-gray-300 bg-gray-50': i !== currentStepIndex,
                }"
                [attr.aria-current]="i === currentStepIndex ? 'step' : null">
                <div class="flex items-center gap-3">
                  <span class="w-7 h-7 rounded-full flex items-center justify-center text-sm"
                        [ngClass]="{
                          'bg-brand-600 text-white': i === currentStepIndex,
                          'bg-gray-200 text-gray-700': i !== currentStepIndex
                        }">
                    {{ i + 1 }}
                  </span>
                  <div class="flex flex-col">
                    <span class="font-semibold tracking-tight text-sm text-text-main">{{ s.label }}</span>
                    @if (s.summary) {
                      <span class="text-xs text-gray-800 tracking-tight opacity-70">{{ s.summary }}</span>
                    }
                  </div>
                </div>
              </button>
            </li>
          }
        </ol>
      </div>
  </aside>

 
  <main class="min-w-0 col-span-3 xl:col-span-6 flex items-center justify-center">
    <div class="flex flex-col gap-8 md:max-w-4/5 xl:max-w-3/5">

    <span class="font-semibold text-base text-brand-600 tracking-tight">Step {{currentStepIndex + 1}} of {{steps.length}}</span>
    @switch (currentStep){
    @case ('SemInfo'){
     <div class="header flex flex-col gap-1 items-start">
       <!-- <div (click)="goBack()" class="back-btn cursor-pointer cursor w-8 h-8 rounded-full flex items-center justify-center border border-gray-300">
         <span class="text-lg">←</span>
       </div> -->
   
       <div class="flex flex-col items-start">
         <span class="text-gray-800 text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight">Set up your semester.</span>
         <span class="text-gray-600 opacity-60 lg:text-xl font-medium tracking-tight">Start by defining your semester dates and schedule name.</span>
       </div>
     </div>
   
     <div class="flex w-full flex-col items-start gap-6">
       <!-- <span class="text-text-main text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight">Semester Information</span> -->
   
       <form [formGroup]="form" (ngSubmit)="onSubmitFirstStep()" class="w-full flex flex-col gap-6">
         <div formGroupName="semester" class="flex flex-col gap-4 w-full">
           
           <app-input-field-base formControlName="schedule_name" [required]="true" label="Semester Name" placeholder="eg. Fall 2025 Semester"></app-input-field-base>
   
           <div class="w-full flex flex-col sm:grid sm:grid-cols-2 gap-4">
       
             <app-date-picker label="Start Date"
               type="date"
               formControlName="start_date"
               [required]="true"
               class="w-full">
             </app-date-picker>
   
             <div class="flex flex-col items-start">
               <app-date-picker label="End Date"
               type="date"
               formControlName="end_date"
               [required]="true"
               class="w-full">
               </app-date-picker>
   
               <!-- Show error message for date range -->
               @if (form.get('semester')?.hasError('dateRange')) {
                 <div class="text-red-500 font-regular tracking-tight text-sm mt-2">
                   End date must be after start date
                 </div>
               }
             </div>
   
           </div>
         </div>
   
         <div class="grid grid-cols-2 gap-4">
          <app-button [routerLink]="'/home'"
           iconName="arrow-left" 
           type="button" 
           text="Back to home" 
           hierarchy="tertiary">
         </app-button>
         <app-button 
           type="submit" 
           [disabled]="form.get('semester')?.invalid" 
           text="Next" 
           hierarchy="primary">
         </app-button>

         </div>

       </form>
     </div>
    }
    @case ('AddClasses'){
       <div class="header flex flex-col gap-1 items-start">
         <div class="flex flex-col items-start">
           <span class="text-gray-800 text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight">Add your classes.</span>
           <span class="text-gray-600 opacity-60 lg:text-xl font-medium max-w-4/5 tracking-tight">Enter course details, pick days and times, set room and color, then add each class.</span>
         </div>
      </div>

      <div class="flex w-full flex-col items-start gap-6">

        <form [formGroup]="classForm" (ngSubmit)="addClass()" class="w-full flex flex-col gap-6">
          <div class="flex flex-col gap-4 w-full">
            <app-input-field-base formControlName="course_name" [required]="true" label="Course Name" placeholder="eg. Calculus II"></app-input-field-base>


            <div class="input-group w-full flex flex-col items-start gap-2">
              <span class="text-sm font-medium text-gray-700 tracking-tight">Days of Week</span>

              <div class="flex flex-wrap gap-2">
                @for (day of daysOfWeek; track $index) {
                  <span
                    (click)="openDayDrawer(day)"
                    [ngClass]="{
                      'bg-brand-50 text-brand-600 border-brand-600': isDaySelected(day),
                      'border-gray-300': !isDaySelected(day)
                    }"
                    class='text-xs border cursor-pointer xl:text-sm font-medium shadow-xs tracking-tight px-3 py-1 rounded-full'>
                  {{day}}
                  </span>
                }
              </div>

              <!-- Microcards under chips -->
               



              <!-- Consistency toolbar -->
              <!-- <div class="w-full mt-2 rounded-lg border border-gray-300 bg-white p-3">
                <div class="flex flex-col md:flex-row md:flex-wrap md:items-center md:justify-between gap-3">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-semiold text-gray-800 tracking-tight">Apply from</span>
                    <select
                      class="text-sm border border-gray-300 rounded-md px-2 py-1 bg-white"
                      [value]="sourceDayIndex"
                      (change)="onChangeSourceIndex($any($event.target).value)">
                      @for (dayGroup of days.controls; let i = $index; track i) {
                        <option [value]="i">{{ dayGroup.get('day')?.value }}</option>
                      }
                    </select>
                    <span class="text-sm text-gary-800 opacity-60">to all selected days</span>
                  </div>
              
                  <div class="flex items-center gap-4">
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                      <input type="checkbox"
                             class="w-4 h-4 rounded border-gray-300 text-gray-800 focus:ring-brand-600"
                             [checked]="syncTimes"
                             (change)="onToggleSyncTimes($any($event.target).checked)">
                      <span class="text-sm font-medium text-gray-800 tracking-tight">Use same time</span>
                    </label>
              
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                      <input type="checkbox"
                             class="w-4 h-4 rounded border-gray-300 text-gray-800 focus:ring-brand-600"
                             [checked]="syncRooms"
                             (change)="onToggleSyncRooms($any($event.target).checked)">
                      <span class="text-sm font-medium text-gray-800 tracking-tight">Use same room</span>
                    </label>
              
                    <app-button
                      type="button"
                      icon="false"
                      (clicked)="applyConsistencyFromSource()"
                      text="Apply now"
                      hierarchy="secondary">
                    </app-button>
                  </div>
                </div>
              </div> -->


              <!-- Day cards -->

              <!-- <button class="btn btn-primary" (click)="drawerOpen = true">Open drawer</button> -->

               
               
              <!-- <div formArrayName="days" class="w-full flex flex-col md:grid md:grid-cols-2 gap-4 mt-4">
                @for (dayGroup of days.controls; track $index) {
                  <div [formGroupName]="$index" class="p-5 border border-gray-300 shadow-xs rounded-lg flex flex-col gap-3 bg-white md:bg-gray-50/500">
                    <span class="text-lg tracking-tight font-semibold text-gray-800">{{dayGroup.get('day')?.value}}</span>
                    <div class="flex w-full flex-col items-start gap-4">
                      <div class="w-full grid grid-cols-2 gap-8">

                        <app-time-picker
                          label="Start Time"
                          formControlName="start_time"
                          placeholder_two="Start at"
                          [required]="true">
                        </app-time-picker>

                        <app-time-picker
                          label="End Time"
                          placeholder_two="End at"
                          formControlName="end_time"
                          [required]="true">
                        </app-time-picker>

                      </div>

                      <app-input-field-base class="w-full" formControlName="room" label="Room" placeholder="eg. Room 101"></app-input-field-base>

                    </div>
                  </div>
                }
              </div> -->
         

            </div>

            @if (days.length >= 1) {
              <div class="microchips-strip px-1 overflow-x-auto scrollbar-none mask-edge-fade">
                <div class="inline-flex items-center gap-2">
                  @for (day of daysOfWeek; track day) {
                    @for (entry of getDayEntries(day); track entry.index) {
                      <div class="inline-flex items-center gap-2 shrink-0 px-3 py-1 rounded-full border border-gray-300 bg-white shadow-xs">
                        <span class="text-xs font-medium text-gray-700">{{ day }}</span>
                        <span class="text-xs text-gray-800">· {{ entry.value.start_time }} – {{ entry.value.end_time }}</span>
                        @if (entry.value.room) {
                          <span class="text-xs text-gray-600">· {{ entry.value.room }}</span>
                        }
                        <button type="button"
                                class="inline-flex items-center justify-center text-brand-600 hover:text-brand-700"
                                (click)="openDayDrawer(day, entry.index)">
                          <i class="ph ph-pencil text-[14px]"></i>
                        </button>
                        <button type="button"
                                class="inline-flex items-center justify-center text-error-500 hover:text-error-700"
                                (click)="removeDayEntry(entry.index)">
                          <i class="ph ph-trash-simple text-[14px]"></i>
                        </button>
                      </div>
                    }
                  }
                </div>
              </div>
            }


               <app-drawer [(open)]="drawerOpen">
                <form [formGroup]="dayEntryForm" (ngSubmit)="saveDayEntry()" class="p-6 flex flex-col gap-4 w-full">
                 <div class="flex items-center justify-between">
                   <span class="text-xl font-semibold text-gray-800 tracking-tight">Add time for {{ activeDay }}</span>
                   <button type="button" class="text-sm text-gray-500 hover:text-gray-700" (click)="drawerOpen = false">Close</button>
                 </div>
             
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                   <app-time-picker [fullWidth]="true" label="Start Time" placeholder_two="Start Time" formControlName="start_time" [required]="true"></app-time-picker>
                   <app-time-picker [fullWidth]="true" label="End Time" placeholder_two="End Time" formControlName="end_time" [required]="true"></app-time-picker>
                 </div>
             
                 <app-input-field-base formControlName="room" label="Room" placeholder="eg. Room 101"></app-input-field-base>
             
                 <div class="flex items-center justify-end gap-3">
                   <app-button type="button" iconName="x" hierarchy="tertiary" text="Cancel" (clicked)="drawerOpen = false"></app-button>
                   <app-button [disabled]="!this.dayEntryForm.valid" type="submit" iconName="plus" hierarchy="primary" text="{{ editingIndex != null ? 'Save changes' : 'Add time' }}"></app-button>
                 </div>
               </form>
               </app-drawer>

            <div class="flex flex-col items-start gap-2 w-full">
                <span class="text-sm font-regular text-gray-800 tracking-tight">Color</span>

                <div class="w-full flex flex-wrap flex-shrink-0 items-center gap-3">
                  @for (color of colorArray; track $index) {
                  <div (click)="toggleColor(color)" [ngClass]="{ 'ring-2 ring-offset-2 ring-brand-600': isColorSelected(color), 'hover:scale-110': true }" [style.backgroundColor]="color" class="w-10 h-10 border border-gray-300 shadow-xs rounded-full">

                  </div>
                }
                </div>



            </div>
          </div>


          <!-- <app-button type="submit" [disabled]="!classForm.valid" text="Add Class" hierarchy="primary"></app-button> -->

          <div class="grid grid-cols-2 gap-4">
          <app-button (clicked)="prevStep()"
           iconName="arrow-left" 
           type="button" 
           text="Back" 
           hierarchy="tertiary">
         </app-button>
         <app-button 
           type="submit" [disabled]="!classForm.valid" text="Add Class" hierarchy="primary">
         </app-button>

         </div>
          
        </form>


        @if (classes.length > 0) {
          <!-- <span class="text-gray-800 font-semibold tracking-tight">Added Classes ({{classes.value.length}})</span> -->

          <app-button (clicked)="sheetOpen = true" iconName="eyes" hierarchy="link-color" text="View Added Classes ({{classes.value.length}})"></app-button>

          <app-sheet [(open)]="sheetOpen">
            <div class="overflow-auto scrollbar-none w-full flex flex-col items-start gap-8 p-4 md:p-6">
              <div class="flex flex-col items-start">
                <span class="font-medium text-lg text-gray-800 tracking-tight">Your added classes.</span>
                <span class="font-regular text-sm text-gray-600 opacity-60 tracking-tight">You can <span (click)="onSubmitSecondStep()" class="underline italic hover:cursor-pointer">preview</span> your schedule once you're done adding your desired classes.</span>
              </div>
        

              <div class="flex w-full flex-col items-start gap-4">
                @for (item of classes.value; track $index) {
              <div [style.backgroundColor]="item.color_light" class="single-class relative w-full items-stretch flex  gap-4 rounded-xl p-3">
                <div [style.backgroundColor]="item.color" class="w-2 flex-shrink-0 rounded-lg"></div>

                <div class="right flex flex-col items-start gap-2 flex-1">
                  <span class="text-gray-800 text-lg font-semibold tracking-tight">{{item.course_name}}</span>

                  <div class="days-group flex flex-col items-start">
                    @for (day of item.days; track $index) {
                      <div class="day flex items-center gap-1">
                        <span class="text-gray-600 opacity-60 font-medium tracking-tight">{{day.day}}: </span>
                        <span class="text-gray-600 opacity-60 font-regular tracking-tight">{{day.start_time}} - {{day.end_time}}</span>
                      </div>
                    }
                  </div>

                  <div class="room flex items-center mt-8">
                    <span class="text-gray-800 font-semibold tracking-tight">
                          Rooms: <span class="font-regular ml-1">{{ getRoomsForClass(item.days) }}</span>
                    </span>
                  </div>


                </div>

                <i (click)="removeClass($index)" class="ph-duotone ph-trash-simple hover:cursor-pointer text-error-500"></i>

              </div>
            }
              </div>

            </div>
          </app-sheet>
          <!-- <div class="flex w-full xl:grid xl:grid-cols-2 flex-col items-start gap-6">
            @for (item of classes.value; track $index) {
              <div [style.backgroundColor]="item.color_light" class="single-class relative w-full items-stretch flex  gap-4 rounded-xl p-5">
                <div [style.backgroundColor]="item.color" class="w-4 flex-shrink-0 rounded-lg"></div>

                <div class="right flex flex-col items-start gap-2 flex-1">
                  <span class="text-text-main text-xl lg:text-2xl SF-Bold tracking-tight">{{item.course_name}}</span>

                  <div class="days-group flex flex-col items-start">
                    @for (day of item.days; track $index) {
                      <div class="day flex items-center gap-1">
                        <span class="text-text-main opacity-60 xl:text-xl SF-Medium tracking-tight">{{day.day}}: </span>
                        <span class="text-text-main opacity-60 xl:text-xl SF-Regular tracking-tight">{{day.start_time}} - {{day.end_time}}</span>
                      </div>
                    }
                  </div>

                  <div class="room flex items-center mt-8">
                    <span class="text-text-main lg:text-xl SF-Bold tracking-tight">
                          Rooms: <span class="SF-Regular ml-1">{{ getRoomsForClass(item.days) }}</span>
                    </span>
                  </div>


                </div>

                <img class="absolute top-5 right-5 w-6 h-6 cursor-pointer" (click)="removeClass($index)" src="/icons/trash.svg" alt="">

              </div>
            }

          </div> -->
          <!-- <app-button type="submit" (click)="onSubmitSecondStep()" [disabled]="classes.length == 0" label="Proceed to Preview" variant="secondary" class="mt-4 xl:text-xl"></app-button> -->
        }


      </div>
    }
    @case ('PreviewSchedule'){
      <div (click)="prevStep()" class="header flex flex-col gap-1 items-start">

         <div class="flex flex-col items-start">
          <span class="text-gray-800 text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight">Preview your schedule.</span>
          <span class="text-gray-600 opacity-60 lg:text-xl fomt-medium tracking-tight">Review your complete schedule before saving.</span>
         </div>

      </div>

      <div class="flex flex-col items-start gap-5 w-full">
           <!-- <div class="header flex flex-col items-start">
             <span class="text-gray-800 text-xl lg:text-2xl font-semibold tracking-tight">Schedule Preview</span>
             <span class="text-gray-600 opacity-60 lg:text-xl font-medium tracking-tight">{{getCompleteSchedulePayload().semester.schedule_name}}</span>
           </div> -->

           <!-- Day Navigation -->
           <div class="day-navigation flex items-center justify-between w-full max-w-sm bg-white border border-gray-300 rounded-lg p-1">
             <button 
               (click)="previousDay()" 
               [disabled]="currentDayIndex === 0"
               class="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
               <span class="text-base ph ph-arrow-left"></span>
             </button>
             
             <span class="tracking-tight fomt-semibold text-gray-800 px-4">
               {{ getCurrentDayName() }}
             </span>
             
             <button 
               (click)="nextDay()" 
               [disabled]="currentDayIndex === availableDays.length - 1"
               class="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
               <span class="text-base ph ph-arrow-right"></span>
             </button>
           </div>

          <!-- Schedule Grid -->
         <div class="schedule-grid w-full bg-white border border-gray-300 rounded-lg overflow-scroll h-[20rem] md:h-[30rem]">
           <!-- Grid container with CSS Grid -->
           <div class="grid grid-cols-[100px_1fr] bg-white">
             
             <!-- Generate time slots from 8:00 to 23:00 -->
             @for (hour of timeSlots; track hour) {
               <!-- Time label -->
               <div class="time-slot border-b border-r border-gray-200 p-3 bg-gray-50 flex items-start">
                 <span class="text-sm SF-Medium text-text-main">{{ hour }}:00</span>
               </div>
               
               <!-- Content area for this hour -->
               <div class="content-slot border-b border-gray-200 relative min-h-[60px] bg-white">
                 <!-- Events for this time slot -->
                 @for (event of getEventsForTimeSlot(hour); track event.id) {
                   <div 
                     [style.backgroundColor]="event.color_light"
                     [style.top.px]="event.topOffset"
                     [style.height.px]="event.height"
                     class="absolute z-[10000] left-0 right-0 mx-1 rounded-md flex items-start gap-2 p-2 border-l-4"
                     [style.border-left-color]="event.color">
                     
                     <div class="flex flex-col">
                       <span class="text-sm xl:text-base font-semibold text-gray-800 tracking-tight">{{ event.course_name }}</span>
                       <span class="text-xs xl:text-sm font-regular text-gray-600 opacity-60 tracking-tight">
                         {{ event.start_time }} - {{ event.end_time }}
                       </span>
                       <!-- <span class="text-xs xl:text-sm SF-Regular text-text-main opacity-70">
                         Room: <span class="SF-Bold text-text-main">{{ event.room }}</span>
                       </span> -->
                     </div>
                   </div>
                 }
               </div>
             }
             
           </div>
         </div>

      </div>

      <div class="grid grid-cols-2 gap-4">
        <app-button (clicked)="prevStep()"
           iconName="arrow-left" 
           type="button" 
           text="Back" 
           hierarchy="tertiary">
         </app-button>
        <app-button 
        (click)="finalizeSchedule()"
        [loading]="isLoading"
        type="submit" 
        text="Save Schedule" 
        hierarchy="primary" 
        class="w-full">
      </app-button>
      </div>
      
    }
  }
  </div>
  </main>
  </div>

</div>
